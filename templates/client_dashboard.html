<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pastillero — Mi Panel</title>
<style>
  body{background:#0a0e12;color:#e2eaf4;font-family:system-ui;margin:0}
  header{padding:18px 22px;border-bottom:1px solid #1e2d3d;display:flex;justify-content:space-between;align-items:center}
  main{padding:22px;max-width:1100px;margin:0 auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid #1e2d3d;text-align:left}
  .btn{padding:8px 10px;border:1px solid #1e2d3d;background:transparent;color:#e2eaf4;border-radius:8px;cursor:pointer}
  .btn:hover{border-color:#00d4aa;color:#00d4aa}
  .badge{padding:3px 10px;border-radius:999px;font-size:.8rem}
  .online{background:rgba(0,212,170,.1);color:#00d4aa}
  .offline{background:rgba(90,122,153,.1);color:#5a7a99}
  .alarm{background:rgba(255,107,53,.1);color:#ff6b35}
</style>
</head>
<body>
<header>
  <div><b>Mi Pastillero</b></div>
  <form method="post" action="/logout"><button class="btn" type="submit">Salir</button></form>
</header>

<main>
  <h3>Mis dispositivos</h3>
  <table>
    <thead>
      <tr><th>Nombre</th><th>Estado</th><th>Firmware</th><th>Último</th><th>Acciones</th></tr>
    </thead>
    <tbody id="body"></tbody>
  </table>
</main>

<script>
function rel(iso){
  if(!iso) return "—";
  const d = new Date(iso + (iso.endsWith("Z")?"":"Z"));
  const s = Math.floor((Date.now() - d.getTime())/1000);
  if(s<60) return `hace ${s}s`;
  if(s<3600) return `hace ${Math.floor(s/60)}m`;
  if(s<86400) return `hace ${Math.floor(s/3600)}h`;
  return `hace ${Math.floor(s/86400)}d`;
}
async function load(){
  const res = await fetch("/api/devices/");
  const devs = await res.json();
  const tbody = document.getElementById("body");
  tbody.innerHTML = devs.map(d=>`
    <tr>
      <td><b>${d.name}</b><div style="opacity:.6;font-size:.8rem">${d.id}</div></td>
      <td><span class="badge ${d.status}">${d.status}</span></td>
      <td>v${d.firmware_version}</td>
      <td>${rel(d.last_seen)}</td>
      <td>
        <button class="btn" onclick="editSchedule('${d.id}')">Horarios</button>
        <button class="btn" onclick="rename('${d.id}','${d.name.replaceAll("'","")}')">Renombrar</button>
      </td>
    </tr>
  `).join("");
}
async function rename(id, current){
  const name = prompt("Nuevo nombre:", current);
  if(!name || name===current) return;
  await fetch(`/api/devices/${id}/name`, {method:"PATCH", headers:{"Content-Type":"application/json"}, body: JSON.stringify({name})});
  load();
}
async function editSchedule(id){
  // Tanda 1: edición simple via JSON (rápida).
  // Luego lo hacemos visual cheto.
  const cur = await fetch(`/api/devices/${id}/schedule`).then(r=>r.json());
  const txt = prompt("Pegá/edita el JSON schedule (Tanda 1):", JSON.stringify(cur.schedule));
  if(!txt) return;
  let schedule;
  try{ schedule = JSON.parse(txt); }catch(e){ alert("JSON inválido"); return; }
  const res = await fetch(`/api/devices/${id}/schedule`, {method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({schedule})});
  if(res.ok) alert("✅ Guardado. El ESP sincroniza por heartbeat.");
  else alert("Error guardando");
}
load();
setInterval(load, 30000);
</script>
</body>
</html>