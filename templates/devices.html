{% extends "base.html" %}

{% block title %}Pastilleros - Pilly Cloud{% endblock %}

{% block page_title %}Pastilleros{% endblock %}
{% block page_description %}Gestioná cada Pilly: API key, estado, OTA por dispositivo, alarmas y comandos remotos.{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Todos los pastilleros</h3>
        <div class="flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="openAddDeviceModal()">
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Agregar pastillero
            </button>
            <button class="btn btn-secondary btn-sm" onclick="loadDevices()">
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Actualizar
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Pastillero</th>
                    <th>IP</th>
                    <th>WiFi</th>
                    <th>Firmware</th>
                    <th>Estado</th>
                    <th>Tiempo activo</th>
                    <th>Memoria libre</th>
                    <th>Última conexión</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="devices-tbody">
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner" style="margin: 20px auto;"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Guía de conexión -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Cómo vincular tu pastillero</h3>
    </div>
    
    <div style="padding: 20px; background: var(--gray-50); border-radius: 8px;">
        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Integration Steps</h4>
        <ol style="margin-left: 20px; line-height: 1.8;">
            <li>Upload the ESP32 example code to your pastillero (see <code>/esp32_examples</code> folder)</li>
            <li>Configure WiFi credentials in the code</li>
            <li>Set the server URL to: <code style="background: var(--white); padding: 2px 6px; border-radius: 4px;">{{ request.url_root }}</code></li>
            <li>The pastillero will automatically register and appear in this list</li>
        </ol>
        
        <div style="margin-top: 16px; padding: 12px; background: var(--white); border-radius: 6px; border-left: 3px solid var(--primary-blue);">
            <strong>API Endpoint for Registration:</strong><br>
            <code style="font-size: 13px; color: var(--gray-700);">POST {{ request.url_root }}api/esp32/register</code>
        </div>
    </div>
</div>

<!-- Device Capabilities -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Device Capabilities</h3>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <svg style="width: 20px; height: 20px; margin-right: 8px; color: var(--primary-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <strong>OTA Updates</strong>
            </div>
            <p style="font-size: 13px; color: var(--gray-600); margin: 0;">Remotely update firmware without physical access</p>
        </div>
        
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <svg style="width: 20px; height: 20px; margin-right: 8px; color: var(--success-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <strong>Real-time Monitoring</strong>
            </div>
            <p style="font-size: 13px; color: var(--gray-600); margin: 0;">Track pastillero status, uptime, and memory usage</p>
        </div>
        
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <svg style="width: 20px; height: 20px; margin-right: 8px; color: var(--warning-orange);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
                <strong>Alarm System</strong>
            </div>
            <p style="font-size: 13px; color: var(--gray-600); margin: 0;">Receive notifications for critical events</p>
        </div>
        
        <div style="padding: 16px; background: var(--gray-50); border-radius: 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <svg style="width: 20px; height: 20px; margin-right: 8px; color: var(--error-red);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <strong>Remote Restart</strong>
            </div>
            <p style="font-size: 13px; color: var(--gray-600); margin: 0;">Restart pastilleros remotely when needed</p>
        </div>
    </div>
</div>

</div>

<!-- Add Device Modal -->
<div id="add-device-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Provisionar pastillero</h3>
        </div>

        <form id="add-device-form" onsubmit="createDeviceFromPanel(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="add-mac">MAC address *</label>
                    <input type="text" id="add-mac" placeholder="AA:BB:CC:DD:EE:FF" required>
                    <small style="font-size: 12px; color: var(--gray-500); display:block; margin-top:4px;">
                        Tip: copiá la MAC tal cual te la imprime el ESP32 / etiqueta
                    </small>
                </div>

                <div class="form-group">
                    <label for="add-name">Nombre</label>
                    <input type="text" id="add-name" placeholder="Pilly de la abuela / Habitación 2 / etc.">
                </div>

                <div class="form-group">
                    <label for="add-fw">Firmware (opcional)</label>
                    <input type="text" id="add-fw" placeholder="e.g., 1.0.0">
                </div>

                <div class="form-group">
                    <label for="add-state">Estado administrativo</label>
                    <select id="add-state">
                        <option value="active" selected>Activo</option>
                        <option value="suspended">Suspendido</option>
                        <option value="blocked">Bloqueado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="add-ota">
                        <span>Habilitar OTA para este pastillero</span>
                    </label>
                </div>

                <div class="form-group">
                    <label for="add-target">Versión OTA objetivo (opcional)</label>
                    <input type="text" id="add-target" placeholder="Si lo dejás vacío, usa stable global">
                </div>

                <div class="alert alert-info" id="add-device-result" style="display:none; margin-top: 12px;">
                    <div style="font-weight:600; margin-bottom: 6px;">✅ Pastillero provisionado</div>
                    <div style="font-size: 13px; color: var(--gray-700);">
                        Guardá esta API key en el ESP32:
                    </div>
                    <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                        <input type="text" id="add-api-key" readonly style="flex:1;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="copyProvisionKey()">Copiar</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddDeviceModal()">Cerrar</button>
                <button type="submit" class="btn btn-primary">Crear</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  if (typeof loadDevices === 'function') loadDevices();
});
</script>
{% endblock %}
