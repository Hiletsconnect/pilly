<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pastillero Cloud â€” Panel de Control</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e14;
    --bg2: #111620;
    --bg3: #1a2030;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #0099cc;
    --green: #00e5a0;
    --red: #ff4466;
    --orange: #ff9944;
    --yellow: #ffd000;
    --text: #c8d8e8;
    --text2: #6a8aaa;
    --text3: #3a5570;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    min-height: 100vh;
  }

  /* â”€â”€ Layout â”€â”€ */
  .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }

  /* â”€â”€ Sidebar â”€â”€ */
  .sidebar {
    background: var(--bg2);
    border-right: 1px solid var(--border);
    padding: 0;
    display: flex;
    flex-direction: column;
  }
  .logo {
    padding: 24px 20px;
    border-bottom: 1px solid var(--border);
  }
  .logo-mark {
    width: 36px; height: 36px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 12px;
    font-size: 18px;
  }
  .logo h1 { font-size: 13px; font-weight: 600; letter-spacing: .05em; text-transform: uppercase; color: var(--text); }
  .logo p { font-size: 11px; color: var(--text2); margin-top: 2px; font-family: var(--mono); }

  .nav { padding: 12px 0; flex: 1; }
  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px;
    cursor: pointer;
    color: var(--text2);
    font-size: 13px;
    font-weight: 500;
    transition: all .15s;
    border-left: 2px solid transparent;
  }
  .nav-item:hover { color: var(--text); background: rgba(0,212,255,.05); }
  .nav-item.active { color: var(--accent); background: rgba(0,212,255,.08); border-left-color: var(--accent); }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text3);
  }

  /* â”€â”€ Main â”€â”€ */
  .main { padding: 32px; overflow: auto; }
  .page { display: none; }
  .page.active { display: block; }

  /* â”€â”€ Page header â”€â”€ */
  .page-header { margin-bottom: 28px; }
  .page-header h2 { font-size: 20px; font-weight: 600; }
  .page-header p { color: var(--text2); font-size: 13px; margin-top: 4px; }

  /* â”€â”€ Stats grid â”€â”€ */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
  }
  .stat-card.blue::before { background: var(--accent); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.red::before { background: var(--red); }
  .stat-card.yellow::before { background: var(--yellow); }
  .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: .08em; color: var(--text2); margin-bottom: 8px; }
  .stat-value { font-size: 32px; font-weight: 300; font-family: var(--mono); }
  .stat-card.blue .stat-value { color: var(--accent); }
  .stat-card.green .stat-value { color: var(--green); }
  .stat-card.red .stat-value { color: var(--red); }
  .stat-card.yellow .stat-value { color: var(--yellow); }
  .stat-sub { font-size: 11px; color: var(--text3); margin-top: 6px; font-family: var(--mono); }

  /* â”€â”€ Table â”€â”€ */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-header h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; }
  table { width: 100%; border-collapse: collapse; }
  th {
    padding: 10px 16px;
    text-align: left;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: .1em;
    color: var(--text3);
    font-weight: 500;
    border-bottom: 1px solid var(--border);
  }
  td {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(30,45,69,.5);
    font-size: 13px;
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(0,212,255,.03); }

  /* â”€â”€ Status badge â”€â”€ */
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-family: var(--mono);
    font-weight: 500;
  }
  .badge-dot { width: 5px; height: 5px; border-radius: 50%; }
  .badge.online { background: rgba(0,229,160,.12); color: var(--green); }
  .badge.online .badge-dot { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
  .badge.offline { background: rgba(255,68,102,.1); color: var(--red); }
  .badge.offline .badge-dot { background: var(--red); }
  .badge.alarming { background: rgba(255,208,0,.12); color: var(--yellow); }
  .badge.alarming .badge-dot { background: var(--yellow); animation: pulse .8s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€ Firmware badge â”€â”€ */
  .fw-badge {
    font-family: var(--mono);
    font-size: 11px;
    background: var(--bg3);
    border: 1px solid var(--border);
    padding: 2px 7px;
    border-radius: 4px;
    color: var(--text2);
  }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all .15s;
    font-family: var(--sans);
  }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #00bbee; }
  .btn-ghost { background: var(--bg3); color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--text3); }
  .btn-danger { background: rgba(255,68,102,.15); color: var(--red); border: 1px solid rgba(255,68,102,.3); }
  .btn-danger:hover { background: rgba(255,68,102,.25); }
  .btn-sm { padding: 4px 10px; font-size: 11px; }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.7); backdrop-filter: blur(4px);
    z-index: 100; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    width: 480px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: .08em; color: var(--text2); margin-bottom: 6px; }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 13px;
    outline: none;
    transition: border-color .15s;
  }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); }
  .form-group textarea { resize: vertical; min-height: 80px; }
  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  /* â”€â”€ IP link â”€â”€ */
  .ip-link { font-family: var(--mono); font-size: 12px; color: var(--accent2); text-decoration: none; }
  .ip-link:hover { color: var(--accent); text-decoration: underline; }

  /* â”€â”€ Event type â”€â”€ */
  .event-type {
    font-family: var(--mono); font-size: 11px;
    padding: 2px 7px; border-radius: 3px;
  }
  .event-alarm_triggered { background: rgba(255,208,0,.1); color: var(--yellow); }
  .event-dose_taken { background: rgba(0,229,160,.1); color: var(--green); }
  .event-dose_missed { background: rgba(255,68,102,.1); color: var(--red); }
  .event-alarm_snoozed { background: rgba(255,153,68,.1); color: var(--orange); }

  /* â”€â”€ Empty state â”€â”€ */
  .empty { padding: 48px; text-align: center; color: var(--text3); }
  .empty-icon { font-size: 36px; margin-bottom: 12px; }
  .empty p { font-size: 13px; }

  /* â”€â”€ Toast â”€â”€ */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    padding: 12px 16px; border-radius: 8px; font-size: 13px;
    background: var(--bg3); border: 1px solid var(--border);
    animation: slideIn .2s ease;
    max-width: 300px;
  }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error { border-color: var(--red); color: var(--red); }
  @keyframes slideIn { from{transform:translateX(20px);opacity:0} to{transform:translateX(0);opacity:1} }

  /* â”€â”€ Loading â”€â”€ */
  .loading { color: var(--text3); font-family: var(--mono); font-size: 12px; padding: 24px; text-align: center; }

  /* â”€â”€ Refresh indicator â”€â”€ */
  .refresh-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--green);
    display: inline-block; margin-left: 8px;
    animation: pulse 2s infinite;
  }
</style>
</head>
<body>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark">ğŸ’Š</div>
      <h1>Pastillero Cloud</h1>
      <p>Panel de Control</p>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">â—ˆ</span> Dashboard
      </div>
      <div class="nav-item" onclick="showPage('devices')">
        <span class="nav-icon">â¬¡</span> Dispositivos
      </div>
      <div class="nav-item" onclick="showPage('history')">
        <span class="nav-icon">â—·</span> Historial
      </div>
      <div class="nav-item" onclick="showPage('firmware')">
        <span class="nav-icon">â†‘</span> Firmware OTA
      </div>
      <div class="nav-item" onclick="showPage('config')">
        <span class="nav-icon">â—</span> ConfiguraciÃ³n
      </div>
    </nav>
    <div class="sidebar-footer">
      Auto-refresh 30s<span class="refresh-dot"></span>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <!-- â”€â”€ Dashboard â”€â”€ -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Estado general de todos los dispositivos</p>
      </div>
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card blue"><div class="stat-label">Total Dispositivos</div><div class="stat-value" id="stat-total">â€”</div></div>
        <div class="stat-card green"><div class="stat-label">En LÃ­nea</div><div class="stat-value" id="stat-online">â€”</div></div>
        <div class="stat-card red"><div class="stat-label">Fuera de LÃ­nea</div><div class="stat-value" id="stat-offline">â€”</div></div>
        <div class="stat-card yellow"><div class="stat-label">Dosis Perdidas</div><div class="stat-value" id="stat-missed">â€”</div><div class="stat-sub" id="stat-taken-sub">â€” tomadas</div></div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Dispositivos Recientes</h3>
          <span id="latest-fw-badge" class="fw-badge">fw â€”</span>
        </div>
        <div id="dashboard-devices-body">
          <div class="loading">Cargando...</div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Devices â”€â”€ -->
    <div id="page-devices" class="page">
      <div class="page-header">
        <h2>Dispositivos</h2>
        <p>GestiÃ³n y control remoto de todos los pastilleros</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>Todos los dispositivos</h3></div>
        <div id="devices-body"><div class="loading">Cargando...</div></div>
      </div>
    </div>

    <!-- â”€â”€ History â”€â”€ -->
    <div id="page-history" class="page">
      <div class="page-header">
        <h2>Historial de Tomas</h2>
        <p>Registro de eventos de todos los dispositivos</p>
      </div>
      <div class="card" style="margin-bottom:16px">
        <div class="card-header"><h3>Filtrar por dispositivo</h3></div>
        <div style="padding:16px">
          <select id="history-device-select" onchange="loadHistory()" style="width:300px;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;outline:none">
            <option value="">â€” Seleccionar dispositivo â€”</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Eventos</h3></div>
        <div id="history-body"><div class="empty"><div class="empty-icon">â—·</div><p>SeleccionÃ¡ un dispositivo para ver el historial</p></div></div>
      </div>
    </div>

    <!-- â”€â”€ Firmware â”€â”€ -->
    <div id="page-firmware" class="page">
      <div class="page-header">
        <h2>Firmware OTA</h2>
        <p>GestiÃ³n de versiones y actualizaciones remotas</p>
      </div>
      <div class="card" style="margin-bottom:20px">
        <div class="card-header"><h3>Subir nueva versiÃ³n</h3></div>
        <div style="padding:20px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
            <div class="form-group" style="margin:0">
              <label>VersiÃ³n (ej: 1.2.3)</label>
              <input type="text" id="fw-version" placeholder="1.0.0">
            </div>
            <div class="form-group" style="margin:0">
              <label>Â¿VersiÃ³n estable?</label>
              <select id="fw-stable">
                <option value="true">SÃ­ â€” desplegar a todos</option>
                <option value="false">No â€” solo pruebas</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Changelog</label>
            <textarea id="fw-changelog" placeholder="DescribÃ­ los cambios de esta versiÃ³n..."></textarea>
          </div>
          <div class="form-group">
            <label>Archivo .bin</label>
            <input type="file" id="fw-file" accept=".bin">
          </div>
          <button class="btn btn-primary" onclick="uploadFirmware()">â†‘ Subir Firmware</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Versiones disponibles</h3></div>
        <div id="firmware-body"><div class="loading">Cargando...</div></div>
      </div>
    </div>

    <!-- â”€â”€ Config â”€â”€ -->
    <div id="page-config" class="page">
      <div class="page-header">
        <h2>ConfiguraciÃ³n</h2>
        <p>Variables de entorno y prueba de integraciones</p>
      </div>
      <div class="card">
        <div class="card-header"><h3>Probar notificaciÃ³n Telegram</h3></div>
        <div style="padding:20px">
          <div class="form-group">
            <label>Chat ID de Telegram</label>
            <input type="text" id="tg-chat-id" placeholder="123456789">
          </div>
          <button class="btn btn-ghost" onclick="testTelegram()">Enviar mensaje de prueba</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h3>Variables de entorno necesarias</h3></div>
        <div style="padding:20px">
          <table>
            <tr><th>Variable</th><th>DescripciÃ³n</th></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">SECRET_KEY</code></td><td>Clave JWT para tokens de admin</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">API_KEY_DEVICES</code></td><td>Clave compartida para autenticar ESP32</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">ADMIN_USERNAME</code></td><td>Usuario del panel admin</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">ADMIN_PASSWORD</code></td><td>ContraseÃ±a del panel admin</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">TELEGRAM_BOT_TOKEN</code></td><td>Token del bot de Telegram</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">TELEGRAM_CHAT_ID</code></td><td>Chat ID global de fallback</td></tr>
            <tr><td><code style="font-family:var(--mono);color:var(--accent);font-size:12px">OFFLINE_THRESHOLD_SECONDS</code></td><td>Segundos sin heartbeat para marcar offline (default: 90)</td></tr>
          </table>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Modal: editar dispositivo -->
<div class="modal-overlay" id="modal-device">
  <div class="modal">
    <h3>âœï¸ Editar Dispositivo</h3>
    <input type="hidden" id="edit-device-id">
    <div class="form-group">
      <label>Nombre</label>
      <input type="text" id="edit-name" placeholder="Pastillero de la abuela">
    </div>
    <div class="form-group">
      <label>Chat ID de Telegram</label>
      <input type="text" id="edit-telegram" placeholder="123456789">
    </div>
    <div class="form-group">
      <label>Notas</label>
      <textarea id="edit-notes" placeholder="Notas internas..."></textarea>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-device')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveDevice()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal: historial dispositivo -->
<div class="modal-overlay" id="modal-history">
  <div class="modal" style="width:640px">
    <h3>â—· Historial del dispositivo</h3>
    <div id="modal-history-body"></div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-history')">Cerrar</button>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toasts"></div>

<script>
const API = '';

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authHeader = '';

function getAuth() {
  if (authHeader) return authHeader;
  const u = prompt('Usuario admin:') || 'admin';
  const p = prompt('ContraseÃ±a:') || 'admin123';
  authHeader = 'Basic ' + btoa(u + ':' + p);
  return authHeader;
}

async function apiFetch(path, options = {}) {
  const res = await fetch(API + path, {
    ...options,
    headers: {
      'Authorization': getAuth(),
      ...(options.headers || {})
    }
  });
  if (res.status === 401) {
    authHeader = '';
    toast('Credenciales incorrectas', 'error');
    throw new Error('Unauthorized');
  }
  return res;
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-item')[['dashboard','devices','history','firmware','config'].indexOf(name)].classList.add('active');
  if (name === 'dashboard') loadDashboard();
  if (name === 'devices') loadDevices();
  if (name === 'firmware') loadFirmware();
  if (name === 'history') loadDeviceSelect();
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [statsRes, devicesRes] = await Promise.all([
      apiFetch('/api/admin/stats'),
      apiFetch('/api/admin/devices')
    ]);
    const stats = await statsRes.json();
    const devices = await devicesRes.json();

    document.getElementById('stat-total').textContent = stats.total_devices;
    document.getElementById('stat-online').textContent = stats.online_devices;
    document.getElementById('stat-offline').textContent = stats.offline_devices;
    document.getElementById('stat-missed').textContent = stats.doses_missed;
    document.getElementById('stat-taken-sub').textContent = stats.doses_taken + ' tomadas';
    if (stats.latest_firmware) {
      document.getElementById('latest-fw-badge').textContent = 'fw ' + stats.latest_firmware;
    }

    renderDevicesTable('dashboard-devices-body', devices.slice(0, 8), true);
  } catch(e) { console.error(e); }
}

// â”€â”€ Devices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDevices() {
  try {
    const res = await apiFetch('/api/admin/devices');
    const devices = await res.json();
    renderDevicesTable('devices-body', devices, false);
  } catch(e) {}
}

function renderDevicesTable(containerId, devices, compact) {
  const el = document.getElementById(containerId);
  if (!devices.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">â¬¡</div><p>No hay dispositivos registrados aÃºn</p></div>';
    return;
  }

  const rows = devices.map(d => {
    const ago = timeAgo(d.last_seen);
    return `<tr>
      <td>
        <div style="font-weight:500">${esc(d.name)}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:2px">${esc(d.id)}</div>
      </td>
      <td><span class="badge ${d.status}"><span class="badge-dot"></span>${d.status}</span></td>
      <td><a href="http://${d.ip_address}" target="_blank" class="ip-link">${esc(d.ip_address) || 'â€”'}</a></td>
      <td><span class="fw-badge">${esc(d.firmware_version)}</span></td>
      <td style="color:var(--text2)">${ago}</td>
      ${!compact ? `
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="openEditModal('${esc(d.id)}','${esc(d.name)}','${esc(d.telegram_chat_id)}','${esc(d.notes)}')">âœï¸</button>
          <button class="btn btn-ghost btn-sm" onclick="viewHistory('${esc(d.id)}','${esc(d.name)}')">â—·</button>
          <button class="btn btn-danger btn-sm" onclick="rebootDevice('${esc(d.id)}','${esc(d.name)}')">â†º Reiniciar</button>
          <button class="btn btn-danger btn-sm" onclick="deleteDevice('${esc(d.id)}','${esc(d.name)}')">âœ•</button>
        </div>
      </td>` : ''}
    </tr>`;
  }).join('');

  el.innerHTML = `<table>
    <thead><tr>
      <th>Dispositivo</th><th>Estado</th><th>IP</th><th>Firmware</th><th>Ãšltima vez</th>
      ${!compact ? '<th>Acciones</th>' : ''}
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function esc(s) { return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function timeAgo(iso) {
  const d = new Date(iso), now = new Date();
  const s = Math.floor((now - d) / 1000);
  if (s < 60) return `${s}s`;
  if (s < 3600) return `${Math.floor(s/60)}min`;
  if (s < 86400) return `${Math.floor(s/3600)}h`;
  return `${Math.floor(s/86400)}d`;
}

// â”€â”€ Device actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditModal(id, name, telegram, notes) {
  document.getElementById('edit-device-id').value = id;
  document.getElementById('edit-name').value = name;
  document.getElementById('edit-telegram').value = telegram;
  document.getElementById('edit-notes').value = notes;
  document.getElementById('modal-device').classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

async function saveDevice() {
  const id = document.getElementById('edit-device-id').value;
  try {
    await apiFetch(`/api/admin/devices/${id}`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        name: document.getElementById('edit-name').value,
        telegram_chat_id: document.getElementById('edit-telegram').value,
        notes: document.getElementById('edit-notes').value,
      })
    });
    toast('Dispositivo actualizado');
    closeModal('modal-device');
    loadDevices();
  } catch(e) { toast('Error al guardar', 'error'); }
}

async function rebootDevice(id, name) {
  if (!confirm(`Â¿Reiniciar "${name}"?\n\nEl dispositivo se reiniciarÃ¡ en el prÃ³ximo heartbeat (~30s).`)) return;
  try {
    await apiFetch(`/api/admin/devices/${id}/reboot`, {method: 'POST'});
    toast(`Reinicio enviado a ${name}`);
    loadDevices();
  } catch(e) { toast('Error al enviar reinicio', 'error'); }
}

async function deleteDevice(id, name) {
  if (!confirm(`Â¿Eliminar "${name}" permanentemente?`)) return;
  try {
    await apiFetch(`/api/admin/devices/${id}`, {method: 'DELETE'});
    toast('Dispositivo eliminado');
    loadDevices();
  } catch(e) { toast('Error al eliminar', 'error'); }
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDeviceSelect() {
  try {
    const res = await apiFetch('/api/admin/devices');
    const devices = await res.json();
    const sel = document.getElementById('history-device-select');
    sel.innerHTML = '<option value="">â€” Seleccionar dispositivo â€”</option>' +
      devices.map(d => `<option value="${esc(d.id)}">${esc(d.name)} (${esc(d.id)})</option>`).join('');
  } catch(e) {}
}

async function loadHistory() {
  const id = document.getElementById('history-device-select').value;
  if (!id) return;
  const el = document.getElementById('history-body');
  el.innerHTML = '<div class="loading">Cargando...</div>';
  try {
    const res = await apiFetch(`/api/admin/devices/${id}/history?limit=100`);
    const events = await res.json();
    if (!events.length) {
      el.innerHTML = '<div class="empty"><div class="empty-icon">â—·</div><p>Sin eventos registrados</p></div>';
      return;
    }
    const rows = events.map(e => `<tr>
      <td><span class="event-type event-${e.event_type}">${e.event_type}</span></td>
      <td>Compartimento ${e.compartment + 1}</td>
      <td style="font-family:var(--mono);color:var(--text2)">${e.scheduled_time || 'â€”'}</td>
      <td style="color:var(--text2)">${new Date(e.occurred_at).toLocaleString('es-AR')}</td>
      <td style="color:var(--text3)">${esc(e.notes)}</td>
    </tr>`).join('');
    el.innerHTML = `<table><thead><tr><th>Evento</th><th>Compartimento</th><th>Horario</th><th>Fecha/Hora</th><th>Notas</th></tr></thead><tbody>${rows}</tbody></table>`;
  } catch(e) { el.innerHTML = '<div class="empty"><p>Error al cargar historial</p></div>'; }
}

async function viewHistory(id, name) {
  const el = document.getElementById('modal-history-body');
  document.querySelector('#modal-history h3').textContent = `â—· Historial â€” ${name}`;
  el.innerHTML = '<div class="loading">Cargando...</div>';
  document.getElementById('modal-history').classList.add('open');
  try {
    const res = await apiFetch(`/api/admin/devices/${id}/history?limit=50`);
    const events = await res.json();
    if (!events.length) { el.innerHTML = '<p style="color:var(--text3);padding:16px 0">Sin eventos</p>'; return; }
    const rows = events.map(e => `<tr>
      <td><span class="event-type event-${e.event_type}">${e.event_type}</span></td>
      <td>Comp. ${e.compartment + 1}</td>
      <td style="font-family:var(--mono);color:var(--text2);font-size:11px">${new Date(e.occurred_at).toLocaleString('es-AR')}</td>
    </tr>`).join('');
    el.innerHTML = `<table><thead><tr><th>Evento</th><th>Compartimento</th><th>Fecha</th></tr></thead><tbody>${rows}</tbody></table>`;
  } catch(e) {}
}

// â”€â”€ Firmware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFirmware() {
  try {
    const res = await apiFetch('/api/admin/firmware');
    const releases = await res.json();
    const el = document.getElementById('firmware-body');
    if (!releases.length) {
      el.innerHTML = '<div class="empty"><div class="empty-icon">â†‘</div><p>No hay versiones subidas</p></div>';
      return;
    }
    const rows = releases.map(r => `<tr>
      <td><span class="fw-badge">${esc(r.version)}</span></td>
      <td><span class="badge ${r.is_stable ? 'online' : 'offline'}"><span class="badge-dot"></span>${r.is_stable ? 'Estable' : 'Beta'}</span></td>
      <td style="color:var(--text2)">${(r.size_bytes/1024).toFixed(1)} KB</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text3)">${r.sha256.substring(0,16)}â€¦</td>
      <td style="color:var(--text2);max-width:200px">${esc(r.changelog) || 'â€”'}</td>
      <td style="color:var(--text3)">${new Date(r.created_at).toLocaleDateString('es-AR')}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteFirmware('${esc(r.version)}')">âœ•</button></td>
    </tr>`).join('');
    el.innerHTML = `<table><thead><tr><th>VersiÃ³n</th><th>Estado</th><th>TamaÃ±o</th><th>SHA256</th><th>Changelog</th><th>Fecha</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
  } catch(e) {}
}

async function uploadFirmware() {
  const version = document.getElementById('fw-version').value.trim();
  const changelog = document.getElementById('fw-changelog').value.trim();
  const stable = document.getElementById('fw-stable').value;
  const file = document.getElementById('fw-file').files[0];

  if (!version || !file) { toast('CompletÃ¡ versiÃ³n y archivo', 'error'); return; }

  const form = new FormData();
  form.append('file', file);

  try {
    const res = await apiFetch(
      `/api/admin/firmware?version=${encodeURIComponent(version)}&changelog=${encodeURIComponent(changelog)}&is_stable=${stable}`,
      {method: 'POST', body: form}
    );
    if (res.ok) {
      toast(`Firmware ${version} subido correctamente`);
      loadFirmware();
      document.getElementById('fw-version').value = '';
      document.getElementById('fw-changelog').value = '';
      document.getElementById('fw-file').value = '';
    } else {
      const err = await res.json();
      toast(err.detail || 'Error al subir', 'error');
    }
  } catch(e) { toast('Error de conexiÃ³n', 'error'); }
}

async function deleteFirmware(version) {
  if (!confirm(`Â¿Eliminar firmware ${version}?`)) return;
  try {
    await apiFetch(`/api/admin/firmware/${version}`, {method: 'DELETE'});
    toast(`Firmware ${version} eliminado`);
    loadFirmware();
  } catch(e) { toast('Error', 'error'); }
}

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testTelegram() {
  const chatId = document.getElementById('tg-chat-id').value.trim();
  if (!chatId) { toast('IngresÃ¡ un chat ID', 'error'); return; }
  try {
    const res = await apiFetch(`/api/admin/telegram/test?chat_id=${chatId}`, {method: 'POST'});
    const data = await res.json();
    if (data.ok) toast('Mensaje enviado a Telegram âœ“');
    else toast('Error al enviar. VerificÃ¡ el token y chat ID', 'error');
  } catch(e) { toast('Error', 'error'); }
}

// â”€â”€ Init & auto-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDashboard();
setInterval(() => {
  const active = document.querySelector('.page.active');
  if (active?.id === 'page-dashboard') loadDashboard();
  if (active?.id === 'page-devices') loadDevices();
}, 30000);
</script>
</body>
</html>
